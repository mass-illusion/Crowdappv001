import React, { useEffect, useState, useRef } from 'react';
import {
  StyleSheet,
  View,
  Text,
  TouchableOpacity,
  TextInput,
  Alert,
  Modal,
  ScrollView,
  ActivityIndicator
} from 'react-native';
import MapboxGL from '@rnmapbox/maps';
import Geolocation from 'react-native-geolocation-service';
import { Ionicons } from '@expo/vector-icons';
import { supabase, FavoritePlace } from '../lib/supabase';
import { MAPBOX_ACCESS_TOKEN, DEFAULT_MAP_CONFIG, PLACE_CATEGORIES } from '../lib/mapbox';

// Initialize Mapbox
MapboxGL.setAccessToken(MAPBOX_ACCESS_TOKEN);

interface MapSearchResult {
  id: string;
  place_name: string;
  center: [number, number];
  properties: {
    category?: string;
  };
}

const MapScreen = () => {
  // State management
  const [userLocation, setUserLocation] = useState<[number, number] | null>(null);
  const [favoritePlaces, setFavoritePlaces] = useState<FavoritePlace[]>([]);
  const [searchQuery, setSearchQuery] = useState('');
  const [searchResults, setSearchResults] = useState<MapSearchResult[]>([]);
  const [selectedPlace, setSelectedPlace] = useState<MapSearchResult | null>(null);
  const [showAddModal, setShowAddModal] = useState(false);
  const [selectedCategory, setSelectedCategory] = useState<keyof typeof PLACE_CATEGORIES>('restaurant');
  const [userNotes, setUserNotes] = useState('');
  const [userRating, setUserRating] = useState(5);
  const [loading, setLoading] = useState(false);
  const [similarUsers, setSimilarUsers] = useState<any[]>([]);

  const mapRef = useRef<MapboxGL.MapView>(null);
  const cameraRef = useRef<MapboxGL.Camera>(null);

  // Get user location on component mount
  useEffect(() => {
    getCurrentLocation();
    loadFavoritePlaces();
  }, []);

  const getCurrentLocation = () => {
    Geolocation.getCurrentPosition(
      (position) => {
        const { latitude, longitude } = position.coords;
        setUserLocation([longitude, latitude]);
        cameraRef.current?.setCamera({
          centerCoordinate: [longitude, latitude],
          zoomLevel: 12,
          animationDuration: 1000,
        });
      },
      (error) => {
        console.log('Location error:', error);
        Alert.alert('Location Error', 'Could not get your current location');
      },
      { enableHighAccuracy: true, timeout: 15000, maximumAge: 10000 }
    );
  };

  // Load user's favorite places from Supabase
  const loadFavoritePlaces = async () => {
    try {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;

      const { data, error } = await supabase
        .from('favorite_places')
        .select('*')
        .eq('user_id', user.id);

      if (error) throw error;
      setFavoritePlaces(data || []);
    } catch (error) {
      console.error('Error loading favorites:', error);
    }
  };

  // Search for places using Mapbox Geocoding API
  const searchPlaces = async (query: string) => {
    if (!query.trim()) {
      setSearchResults([]);
      return;
    }

    try {
      const response = await fetch(
        `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?access_token=${MAPBOX_ACCESS_TOKEN}&types=poi&limit=10`
      );
      const data = await response.json();
      setSearchResults(data.features || []);
    } catch (error) {
      console.error('Search error:', error);
    }
  };

  // Add place to favorites
  const addToFavorites = async () => {
    if (!selectedPlace) return;

    try {
      setLoading(true);
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        Alert.alert('Error', 'Please log in to save favorites');
        return;
      }

      const newFavorite: Omit<FavoritePlace, 'id' | 'created_at' | 'updated_at'> = {
        user_id: user.id,
        place_id: selectedPlace.id,
        name: selectedPlace.place_name,
        category: selectedCategory,
        latitude: selectedPlace.center[1],
        longitude: selectedPlace.center[0],
        rating: userRating,
        notes: userNotes,
      };

      const { error } = await supabase
        .from('favorite_places')
        .insert([newFavorite]);

      if (error) throw error;

      Alert.alert('Success', 'Place added to favorites!');
      setShowAddModal(false);
      loadFavoritePlaces();
      findSimilarUsers(selectedPlace.id);
    } catch (error) {
      console.error('Error adding favorite:', error);
      Alert.alert('Error', 'Could not add place to favorites');
    } finally {
      setLoading(false);
    }
  };

  // Find users with similar favorite places
  const findSimilarUsers = async (placeId: string) => {
    try {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;

      const { data, error } = await supabase
        .from('favorite_places')
        .select(`
          user_id,
          profiles:user_id (
            username,
            full_name,
            avatar_url
          )
        `)
        .eq('place_id', placeId)
        .neq('user_id', user.id);

      if (error) throw error;
      setSimilarUsers(data || []);
    } catch (error) {
      console.error('Error finding similar users:', error);
    }
  };

  // Render place markers
  const renderPlaceMarkers = () => {
    return favoritePlaces.map((place) => (
      <MapboxGL.PointAnnotation
        key={place.id}
        id={place.id}
        coordinate={[place.longitude, place.latitude]}
      >
        <View style={[
          styles.markerContainer,
          { backgroundColor: PLACE_CATEGORIES[place.category].color }
        ]}>
          <Text style={styles.markerEmoji}>
            {PLACE_CATEGORIES[place.category].icon}
          </Text>
        </View>
        <MapboxGL.Callout title={place.name}>
          <View style={styles.calloutContainer}>
            <Text style={styles.calloutTitle}>{place.name}</Text>
            <Text style={styles.calloutCategory}>
              {PLACE_CATEGORIES[place.category].label}
            </Text>
            {place.rating && (
              <Text style={styles.calloutRating}>
                Rating: {place.rating}/5 ‚≠ê
              </Text>
            )}
            {place.notes && (
              <Text style={styles.calloutNotes}>{place.notes}</Text>
            )}
          </View>
        </MapboxGL.Callout>
      </MapboxGL.PointAnnotation>
    ));
  };

  return (
    <View style={styles.container}>
      {/* Search Bar */}
      <View style={styles.searchContainer}>
        <TextInput
          style={styles.searchInput}
          placeholder="Search for restaurants, bars, cafes..."
          value={searchQuery}
          onChangeText={(text: string) => {
            setSearchQuery(text);
            searchPlaces(text);
          }}
        />
        <TouchableOpacity
          style={styles.locationButton}
          onPress={getCurrentLocation}
        >
          <Ionicons name="locate" size={24} color="#007AFF" />
        </TouchableOpacity>
      </View>

      {/* Search Results */}
      {searchResults.length > 0 && (
        <ScrollView style={styles.searchResults}>
          {searchResults.map((result) => (
            <TouchableOpacity
              key={result.id}
              style={styles.searchResultItem}
              onPress={() => {
                setSelectedPlace(result);
                setShowAddModal(true);
                setSearchResults([]);
                setSearchQuery('');
                cameraRef.current?.setCamera({
                  centerCoordinate: result.center,
                  zoomLevel: 15,
                  animationDuration: 1000,
                });
              }}
            >
              <Text style={styles.searchResultName}>{result.place_name}</Text>
            </TouchableOpacity>
          ))}
        </ScrollView>
      )}

      {/* Map */}
      <MapboxGL.MapView
        ref={mapRef}
        style={styles.map}
        styleURL={DEFAULT_MAP_CONFIG.style}
      >
        <MapboxGL.Camera
          ref={cameraRef}
          defaultSettings={{
            centerCoordinate: DEFAULT_MAP_CONFIG.center,
            zoomLevel: DEFAULT_MAP_CONFIG.zoom,
          }}
        />

        {/* User location */}
        {userLocation && (
          <MapboxGL.PointAnnotation
            id=\"user-location\"
            coordinate={userLocation}
          >
            <View style={styles.userLocationMarker}>
              <View style={styles.userLocationDot} />
            </View>
          </MapboxGL.PointAnnotation>
        )}

        {/* Favorite place markers */}
        {renderPlaceMarkers()}
      </MapboxGL.MapView>

      {/* Category Filter */}
      <View style={styles.categoryFilter}>
        <ScrollView horizontal showsHorizontalScrollIndicator={false}>
          {Object.entries(PLACE_CATEGORIES).map(([key, category]) => {
            const typedCategory = category as (typeof PLACE_CATEGORIES)[keyof typeof PLACE_CATEGORIES];
            return (
              <TouchableOpacity
                key={key}
                style={[
                  styles.categoryButton,
                  { backgroundColor: typedCategory.color }
                ]}
                onPress={() => {
                  // Filter favorites by category
                  // You can implement filtering logic here
                }}
              >
                <Text style={styles.categoryEmoji}>{typedCategory.icon}</Text>
                <Text style={styles.categoryLabel}>{typedCategory.label}</Text>
              </TouchableOpacity>
            );
          })}
        </ScrollView>
      </View>

      {/* Add to Favorites Modal */}
      <Modal
        visible={showAddModal}
        transparent
        animationType=\"slide\"
        onRequestClose={() => setShowAddModal(false)}
      >
        <View style={styles.modalOverlay}>
          <View style={styles.modalContainer}>
            <Text style={styles.modalTitle}>Add to Favorites</Text>
            <Text style={styles.placeName}>{selectedPlace?.place_name}</Text>

            {/* Category Selection */}
            <Text style={styles.sectionTitle}>Category:</Text>
            <ScrollView horizontal style={styles.categorySelector}>
              {Object.entries(PLACE_CATEGORIES).map(([key, category]) => (
                <TouchableOpacity
                  key={key}
                  style={[
                    styles.categorySelectorItem,
                    selectedCategory === key && styles.selectedCategory
                  ]}
                  onPress={() => setSelectedCategory(key as keyof typeof PLACE_CATEGORIES)}
                >
                  <Text style={styles.categoryEmoji}>{category.icon}</Text>
                  <Text style={styles.categoryLabel}>{category.label}</Text>
                </TouchableOpacity>
              ))}
            </ScrollView>

            {/* Rating */}
            <Text style={styles.sectionTitle}>Rating:</Text>
            <View style={styles.ratingContainer}>
              {[1, 2, 3, 4, 5].map((star) => (
                <TouchableOpacity
                  key={star}
                  onPress={() => setUserRating(star)}
                >
                  <Text style={styles.star}>
                    {star <= userRating ? '‚≠ê' : '‚òÜ'}
                  </Text>
                </TouchableOpacity>
              ))}
            </View>

            {/* Notes */}
            <Text style={styles.sectionTitle}>Notes (optional):</Text>
            <TextInput
              style={styles.notesInput}
              placeholder=\"Add your thoughts about this place...\"
              value={userNotes}
              onChangeText={setUserNotes}
              multiline
            />

            {/* Similar Users */}
            {similarUsers.length > 0 && (
              <View>
                <Text style={styles.sectionTitle}>
                  {similarUsers.length} other user(s) also love this place!
                </Text>
                {similarUsers.slice(0, 3).map((user, index) => (
                  <Text key={index} style={styles.similarUser}>
                    üë§ {user.profiles?.username || user.profiles?.full_name || 'Anonymous'}
                  </Text>
                ))}
              </View>
            )}

            <View style={styles.modalButtons}>
              <TouchableOpacity
                style={styles.cancelButton}
                onPress={() => setShowAddModal(false)}
              >
                <Text style={styles.cancelButtonText}>Cancel</Text>
              </TouchableOpacity>
              <TouchableOpacity
                style={styles.addButton}
                onPress={addToFavorites}
                disabled={loading}
              >
                {loading ? (
                  <ActivityIndicator color="white" />
                ) : (
                  <Text style={styles.addButtonText}>Add to Favorites</Text>
                )}
              </TouchableOpacity>
            </View>
          </View>
        </View>
      </Modal>
    </View>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
  },
  searchContainer: {
    position: 'absolute',
    top: 60,
    left: 16,
    right: 16,
    zIndex: 1000,
    flexDirection: 'row',
    alignItems: 'center',
  },
  searchInput: {
    flex: 1,
    backgroundColor: 'white',
    borderRadius: 25,
    paddingHorizontal: 20,
    paddingVertical: 12,
    fontSize: 16,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.1,
    shadowRadius: 8,
    elevation: 3,
  },
  locationButton: {
    marginLeft: 12,
    backgroundColor: 'white',
    borderRadius: 25,
    padding: 12,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.1,
    shadowRadius: 8,
    elevation: 3,
  },
  searchResults: {
    position: 'absolute',
    top: 120,
    left: 16,
    right: 16,
    maxHeight: 200,
    backgroundColor: 'white',
    borderRadius: 12,
    zIndex: 999,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.1,
    shadowRadius: 8,
    elevation: 3,
  },
  searchResultItem: {
    padding: 16,
    borderBottomWidth: 1,
    borderBottomColor: '#f0f0f0',
  },
  searchResultName: {
    fontSize: 16,
    fontWeight: '500',
  },
  map: {
    flex: 1,
  },
  markerContainer: {
    width: 40,
    height: 40,
    borderRadius: 20,
    alignItems: 'center',
    justifyContent: 'center',
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.25,
    shadowRadius: 3.84,
    elevation: 5,
  },
  markerEmoji: {
    fontSize: 20,
  },
  userLocationMarker: {
    width: 20,
    height: 20,
    borderRadius: 10,
    backgroundColor: 'rgba(0, 122, 255, 0.3)',
    alignItems: 'center',
    justifyContent: 'center',
  },
  userLocationDot: {
    width: 10,
    height: 10,
    borderRadius: 5,
    backgroundColor: '#007AFF',
  },
  calloutContainer: {
    padding: 12,
    backgroundColor: 'white',
    borderRadius: 8,
    maxWidth: 200,
  },
  calloutTitle: {
    fontSize: 16,
    fontWeight: 'bold',
    marginBottom: 4,
  },
  calloutCategory: {
    fontSize: 14,
    color: '#666',
    marginBottom: 4,
  },
  calloutRating: {
    fontSize: 14,
    marginBottom: 4,
  },
  calloutNotes: {
    fontSize: 12,
    fontStyle: 'italic',
    color: '#888',
  },
  categoryFilter: {
    position: 'absolute',
    bottom: 100,
    left: 0,
    right: 0,
    paddingHorizontal: 16,
  },
  categoryButton: {
    marginRight: 12,
    paddingHorizontal: 16,
    paddingVertical: 8,
    borderRadius: 20,
    alignItems: 'center',
    minWidth: 80,
  },
  categoryEmoji: {
    fontSize: 16,
    marginBottom: 2,
  },
  categoryLabel: {
    fontSize: 10,
    color: 'white',
    fontWeight: 'bold',
  },
  modalOverlay: {
    flex: 1,
    backgroundColor: 'rgba(0, 0, 0, 0.5)',
    justifyContent: 'flex-end',
  },
  modalContainer: {
    backgroundColor: 'white',
    borderTopLeftRadius: 20,
    borderTopRightRadius: 20,
    padding: 20,
    maxHeight: '80%',
  },
  modalTitle: {
    fontSize: 20,
    fontWeight: 'bold',
    marginBottom: 8,
    textAlign: 'center',
  },
  placeName: {
    fontSize: 16,
    color: '#666',
    textAlign: 'center',
    marginBottom: 20,
  },
  sectionTitle: {
    fontSize: 16,
    fontWeight: '600',
    marginTop: 16,
    marginBottom: 8,
  },
  categorySelector: {
    marginBottom: 16,
  },
  categorySelectorItem: {
    marginRight: 12,
    padding: 12,
    borderRadius: 12,
    alignItems: 'center',
    backgroundColor: '#f0f0f0',
    minWidth: 80,
  },
  selectedCategory: {
    backgroundColor: '#007AFF',
  },
  ratingContainer: {
    flexDirection: 'row',
    marginBottom: 16,
  },
  star: {
    fontSize: 24,
    marginRight: 8,
  },
  notesInput: {
    borderWidth: 1,
    borderColor: '#ddd',
    borderRadius: 8,
    padding: 12,
    minHeight: 80,
    textAlignVertical: 'top',
    marginBottom: 16,
  },
  similarUser: {
    fontSize: 14,
    color: '#666',
    marginBottom: 4,
  },
  modalButtons: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    marginTop: 20,
  },
  cancelButton: {
    flex: 1,
    padding: 16,
    borderRadius: 8,
    backgroundColor: '#f0f0f0',
    marginRight: 8,
    alignItems: 'center',
  },
  cancelButtonText: {
    fontSize: 16,
    color: '#666',
  },
  addButton: {
    flex: 1,
    padding: 16,
    borderRadius: 8,
    backgroundColor: '#007AFF',
    marginLeft: 8,
    alignItems: 'center',
  },
  addButtonText: {
    fontSize: 16,
    color: 'white',
    fontWeight: 'bold',
  },
});

export default MapScreen;